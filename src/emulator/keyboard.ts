// HD61700 keyboard matrix
// Ported from keyboard.pas — data tables ported verbatim

export const KEYPADS      = 8;   // index of last item in keypad[]
export const LASTKEYCODE  = 83;

export interface KeyBlock {
  L: number;  // left pixel
  T: number;  // top pixel
  W: number;  // key width
  H: number;  // key height
  SX: number; // horizontal spacing
  SY: number; // vertical spacing
  col: number; // columns in block
  cnt: number; // keys in block
  OX: number;  // source X in keys.png (512 = absent)
  OY: number;  // source Y in keys.png
}

// keypad geometry blocks (pixel coordinates in the face.png image)
export const keypad: readonly KeyBlock[] = [
  /* 0 */ { L:35,  T:219, W:5,  H:5,  SX:40, SY:33, col:1,  cnt:1,  OX:512, OY:512 }, // All Reset
  /* 1 */ { L:20,  T:145, W:33, H:21, SX:40, SY:99, col:1,  cnt:2,  OX:76,  OY:27  }, // OFF, CAPS
  /* 2 */ { L:60,  T:145, W:33, H:21, SX:40, SY:66, col:10, cnt:20, OX:76,  OY:27  }, // MEMO..ANS rows 1+3
  /* 3 */ { L:31,  T:178, W:33, H:21, SX:40, SY:33, col:11, cnt:11, OX:76,  OY:27  }, // Q..ENG row 2
  /* 4 */ { L:71,  T:244, W:33, H:21, SX:40, SY:33, col:10, cnt:10, OX:76,  OY:27  }, // Z..Space row 4
  /* 5 */ { L:484, T:17,  W:30, H:19, SX:36, SY:33, col:6,  cnt:18, OX:142, OY:27  }, // small keys 3 rows
  /* 6 */ { L:481, T:118, W:38, H:27, SX:44, SY:40, col:5,  cnt:18, OX:0,   OY:27  }, // large keys 4 rows
  /* 7 */ { L:613, T:238, W:82, H:27, SX:88, SY:40, col:1,  cnt:1,  OX:0,   OY:0   }, // EXE key
  /* 8 */ { L:5,   T:5,   W:17, H:17, SX:18, SY:33, col:2,  cnt:2,  OX:164, OY:0   }, // app min/close
];

// ─── key state ────────────────────────────────────────────────────────────────
export let keyCode1 = 0; // key pressed via mouse
export let keyCode2 = 0; // key pressed via keyboard

export function setKeyCode1(v: number) { keyCode1 = v; }
export function setKeyCode2(v: number) { keyCode2 = v; }

// ─── KeyTab[KO][keyCode] → KY contribution ───────────────────────────────────
// Verbatim from keyboard.pas — 16 KO columns × 84 key codes
export const keyTab: readonly (readonly number[])[] = [

/* KO 0 – none selected: all zeros */
[ 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000 ],

/* KO 1 */
[ 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0080,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000 ],

/* KO 2 */
[ 0x0000,
  0x0000, 0x0080, 0x0000,
  0x0000, 0x0040, 0x0000, 0x0020, 0x0000, 0x0010, 0x0000, 0x0008, 0x0000, 0x0004,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0002, 0x0001, 0x8000, 0x0000, 0x4000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000 ],

/* KO 3 */
[ 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0080, 0x0000, 0x0040, 0x0000, 0x0020, 0x0000, 0x0010, 0x0000, 0x0008, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x8000, 0x0000, 0x4000,
  0x0002, 0x0001, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0004, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000 ],

/* KO 4 */
[ 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0080, 0x0000, 0x0040, 0x0000, 0x0020, 0x0000, 0x0010, 0x0000, 0x0008, 0x0000,
  0x0004,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0001, 0x8000, 0x4000, 0x0000,
  0x0002, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000 ],

/* KO 5 */
[ 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0080, 0x0000, 0x0040, 0x0000, 0x0020, 0x0000, 0x0010, 0x0000, 0x0008,
  0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x4000,
  0x0000, 0x0002, 0x0001, 0x8000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0004, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000 ],

/* KO 6 */
[ 0x0000,
  0x0080, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0040, 0x0000, 0x0020, 0x0000, 0x0010, 0x0000, 0x0008, 0x0000, 0x0004,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x8000, 0x4000,
  0x0000, 0x0002, 0x0001, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000 ],

/* KO 7 */
[ 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0080, 0x0000, 0x0040, 0x0000, 0x0020, 0x0000, 0x0010, 0x0000, 0x0008, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x8000, 0x0000,
  0x0000, 0x0002, 0x0001, 0x0000, 0x4000,
  0x0004, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000 ],

/* KO 8 */
[ 0x0000,
  0x0000, 0x0000, 0x0080,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0040, 0x0000, 0x0020, 0x0000, 0x0010, 0x0000, 0x0008, 0x0000, 0x0004,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x8000, 0x0000,
  0x0000, 0x0002, 0x0001, 0x0000, 0x4000,
  0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000 ],

/* KO 9 */
[ 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000,
  0x0080, 0x0000, 0x0040, 0x0000, 0x0020, 0x0000, 0x0010, 0x0000, 0x0008, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x8000, 0x0000,
  0x0004, 0x0002, 0x0001,
  0x4000,
  0x0000, 0x0000 ],

/* KO 10 – all zeros */
[ 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000 ],

/* KO 11 – all zeros */
[ 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000 ],

/* KO 12 – all zeros */
[ 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000 ],

/* KO 13 – all columns selected */
[ 0x0000,
  0x0080, 0x0080, 0x0080,
  0x0080, 0x0040, 0x0040, 0x0020, 0x0020, 0x0010, 0x0010, 0x0008, 0x0008, 0x0004,
  0x0080, 0x0040, 0x0040, 0x0020, 0x0020, 0x0010, 0x0010, 0x0008, 0x0008, 0x0004,
  0x0080, 0x0080, 0x0040, 0x0040, 0x0020, 0x0020, 0x0010, 0x0010, 0x0008, 0x0008,
  0x0004,
  0x0080, 0x0040, 0x0040, 0x0020, 0x0020, 0x0010, 0x0010, 0x0008, 0x0008, 0x0004,
  0x0002, 0x0001, 0x8000, 0x8000, 0x4000, 0x4000,
  0x0002, 0x0001, 0x0001, 0x8000, 0x4000, 0x4000,
  0x0002, 0x0002, 0x0001, 0x8000, 0x8000, 0x4000,
  0x0004, 0x0002, 0x0001, 0x8000, 0x0080,
  0x0004, 0x0002, 0x0001, 0x8000, 0x4000,
  0x0004, 0x0002, 0x0001, 0x8000, 0x4000,
  0x0004, 0x0002, 0x0001,
  0x4000,
  0x0000, 0x0000 ],

/* KO 14 – all zeros */
[ 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000 ],

/* KO 15 – all zeros */
[ 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000 ],

];

// Return KY register contribution for KO column
export function readKy(ko: number): number {
  const row = keyTab[ko & 0xF];
  return (row[keyCode1] | row[keyCode2]) & 0xFFFF;
}
