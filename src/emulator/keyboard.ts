// HD61700 keyboard matrix
// Ported from keyboard.pas — data tables ported verbatim

export const KEYPADS      = 8;   // index of last item in keypad[]
export const LASTKEYCODE  = 83;

export interface KeyBlock {
  L: number;  // left pixel
  T: number;  // top pixel
  W: number;  // key width
  H: number;  // key height
  SX: number; // horizontal spacing
  SY: number; // vertical spacing
  col: number; // columns in block
  cnt: number; // keys in block
  OX: number;  // source X in keys.png (512 = absent)
  OY: number;  // source Y in keys.png
}

// keypad geometry blocks (pixel coordinates in the face.png image)
export const keypad: readonly KeyBlock[] = [
  /* 0 */ { L:35,  T:219, W:5,  H:5,  SX:40, SY:33, col:1,  cnt:1,  OX:512, OY:512 }, // All Reset
  /* 1 */ { L:20,  T:145, W:33, H:21, SX:40, SY:99, col:1,  cnt:2,  OX:76,  OY:27  }, // OFF, CAPS
  /* 2 */ { L:60,  T:145, W:33, H:21, SX:40, SY:66, col:10, cnt:20, OX:76,  OY:27  }, // MEMO..ANS rows 1+3
  /* 3 */ { L:31,  T:178, W:33, H:21, SX:40, SY:33, col:11, cnt:11, OX:76,  OY:27  }, // Q..ENG row 2
  /* 4 */ { L:71,  T:244, W:33, H:21, SX:40, SY:33, col:10, cnt:10, OX:76,  OY:27  }, // Z..Space row 4
  /* 5 */ { L:484, T:17,  W:30, H:19, SX:36, SY:33, col:6,  cnt:18, OX:142, OY:27  }, // small keys 3 rows
  /* 6 */ { L:481, T:118, W:38, H:27, SX:44, SY:40, col:5,  cnt:18, OX:0,   OY:27  }, // large keys 4 rows
  /* 7 */ { L:613, T:238, W:82, H:27, SX:88, SY:40, col:1,  cnt:1,  OX:0,   OY:0   }, // EXE key
  /* 8 */ { L:5,   T:5,   W:17, H:17, SX:18, SY:33, col:2,  cnt:2,  OX:164, OY:0   }, // app min/close
];

// ─── key position lookup ─────────────────────────────────────────────────────
// Maps a key code to its pixel position on face.png and sprite sheet coords.

export interface KeyPosition {
  x: number;   // face.png left pixel
  y: number;   // face.png top pixel
  w: number;   // key width
  h: number;   // key height
  ox: number;  // sprite sheet X (pressed state at ox, released at ox+w)
  oy: number;  // sprite sheet Y
}

export function keyCodeToPosition(code: number): KeyPosition | null {
  if (code < 1 || code > LASTKEYCODE) return null;
  let base = 1;
  for (let i = 0; i <= KEYPADS; i++) {
    const b = keypad[i];
    if (code < base + b.cnt) {
      if (b.OX >= 512) return null; // no sprite (e.g. All Reset)
      const idx = code - base;
      const col = idx % b.col;
      const row = Math.floor(idx / b.col);
      return {
        x: b.L + col * b.SX,
        y: b.T + row * b.SY,
        w: b.W,
        h: b.H,
        ox: b.OX,
        oy: b.OY,
      };
    }
    base += b.cnt;
  }
  return null;
}

// ─── key state ────────────────────────────────────────────────────────────────
export let keyCode1  = 0; // key pressed via mouse
export let keyCode2  = 0; // key pressed via keyboard (base key)
export let keyCode2b = 0; // simultaneous modifier key from keyboard (e.g. red S for shift combos)

export function setKeyCode1(v: number)  { keyCode1  = v; }
export function setKeyCode2(v: number)  { keyCode2  = v; }
export function setKeyCode2b(v: number) { keyCode2b = v; }

// ─── keyboard input buffer ──────────────────────────────────────────────────
// Queues keystroke events so that fast typing doesn't drop characters.
// Each key is held active for a minimum duration before the next is presented,
// guaranteeing the ROM's 256 Hz key-scan loop sees every press.

interface BufferedKey {
  code: number;       // keyCode2 value
  modifier: number;   // keyCode2b value (e.g. RED_S for shift combos)
  interrupt: boolean;  // whether to fire keyInterrupt after presenting
}

const _keyBuffer: BufferedKey[] = [];
let _bufferTimer: ReturnType<typeof setTimeout> | null = null;
let _interruptFn: (() => void) | null = null;

// Minimum time (ms) a key is held before the next buffered key is presented.
// At 256 Hz scan rate, 35 ms guarantees ~9 scan cycles — enough for the ROM
// to detect the press AND the subsequent release gap.
const KEY_HOLD_MS = 35;
// Gap between keys where keyCode2=0, so the ROM sees a release before next key.
const KEY_GAP_MS = 15;

/** Register the interrupt callback (called from KeyboardOverlay on mount). */
export function setKeyInterruptFn(fn: (() => void) | null): void {
  _interruptFn = fn;
}

/** Push a key event into the buffer. If nothing is active, present it now. */
export function bufferKey(code: number, modifier: number = 0, interrupt: boolean = true): void {
  _keyBuffer.push({ code, modifier, interrupt });
  if (_bufferTimer === null && keyCode2 === 0) {
    _presentNext();
  }
}

/** Clear the buffer and release current key (used on keyUp for the active key). */
export function bufferClear(): void {
  _keyBuffer.length = 0;
  if (_bufferTimer !== null) { clearTimeout(_bufferTimer); _bufferTimer = null; }
  keyCode2 = 0;
  keyCode2b = 0;
}

function _presentNext(): void {
  if (_keyBuffer.length === 0) {
    // Nothing queued — release key and stop
    keyCode2 = 0;
    keyCode2b = 0;
    _bufferTimer = null;
    return;
  }
  const entry = _keyBuffer.shift()!;
  keyCode2 = entry.code;
  keyCode2b = entry.modifier;
  if (entry.interrupt && _interruptFn) _interruptFn();
  // Hold this key for KEY_HOLD_MS, then insert a release gap
  _bufferTimer = setTimeout(() => {
    keyCode2 = 0;
    keyCode2b = 0;
    // Brief gap so ROM sees the release, then present next key
    _bufferTimer = setTimeout(() => {
      _presentNext();
    }, KEY_GAP_MS);
  }, KEY_HOLD_MS);
}

/** Number of pending keys in the buffer (for diagnostics). */
export function bufferLength(): number { return _keyBuffer.length; }

// ─── KeyTab[KO][keyCode] → KY contribution ───────────────────────────────────
// Verbatim from keyboard.pas — 16 KO columns × 84 key codes
export const keyTab: readonly (readonly number[])[] = [

/* KO 0 – none selected: all zeros */
[ 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000 ],

/* KO 1 */
[ 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0080,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000 ],

/* KO 2 */
[ 0x0000,
  0x0000, 0x0080, 0x0000,
  0x0000, 0x0040, 0x0000, 0x0020, 0x0000, 0x0010, 0x0000, 0x0008, 0x0000, 0x0004,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0002, 0x0001, 0x8000, 0x0000, 0x4000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000 ],

/* KO 3 */
[ 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0080, 0x0000, 0x0040, 0x0000, 0x0020, 0x0000, 0x0010, 0x0000, 0x0008, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x8000, 0x0000, 0x4000,
  0x0002, 0x0001, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0004, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000 ],

/* KO 4 */
[ 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0080, 0x0000, 0x0040, 0x0000, 0x0020, 0x0000, 0x0010, 0x0000, 0x0008, 0x0000,
  0x0004,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0001, 0x8000, 0x4000, 0x0000,
  0x0002, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000 ],

/* KO 5 */
[ 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0080, 0x0000, 0x0040, 0x0000, 0x0020, 0x0000, 0x0010, 0x0000, 0x0008,
  0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x4000,
  0x0000, 0x0002, 0x0001, 0x8000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0004, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000 ],

/* KO 6 */
[ 0x0000,
  0x0080, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0040, 0x0000, 0x0020, 0x0000, 0x0010, 0x0000, 0x0008, 0x0000, 0x0004,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x8000, 0x4000,
  0x0000, 0x0002, 0x0001, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000 ],

/* KO 7 */
[ 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0080, 0x0000, 0x0040, 0x0000, 0x0020, 0x0000, 0x0010, 0x0000, 0x0008, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x8000, 0x0000,
  0x0000, 0x0002, 0x0001, 0x0000, 0x4000,
  0x0004, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000 ],

/* KO 8 */
[ 0x0000,
  0x0000, 0x0000, 0x0080,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0040, 0x0000, 0x0020, 0x0000, 0x0010, 0x0000, 0x0008, 0x0000, 0x0004,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x8000, 0x0000,
  0x0000, 0x0002, 0x0001, 0x0000, 0x4000,
  0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000 ],

/* KO 9 */
[ 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000,
  0x0080, 0x0000, 0x0040, 0x0000, 0x0020, 0x0000, 0x0010, 0x0000, 0x0008, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x8000, 0x0000,
  0x0004, 0x0002, 0x0001,
  0x4000,
  0x0000, 0x0000 ],

/* KO 10 – all zeros */
[ 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000 ],

/* KO 11 – all zeros */
[ 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000 ],

/* KO 12 – all zeros */
[ 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000 ],

/* KO 13 – all columns selected */
[ 0x0000,
  0x0080, 0x0080, 0x0080,
  0x0080, 0x0040, 0x0040, 0x0020, 0x0020, 0x0010, 0x0010, 0x0008, 0x0008, 0x0004,
  0x0080, 0x0040, 0x0040, 0x0020, 0x0020, 0x0010, 0x0010, 0x0008, 0x0008, 0x0004,
  0x0080, 0x0080, 0x0040, 0x0040, 0x0020, 0x0020, 0x0010, 0x0010, 0x0008, 0x0008,
  0x0004,
  0x0080, 0x0040, 0x0040, 0x0020, 0x0020, 0x0010, 0x0010, 0x0008, 0x0008, 0x0004,
  0x0002, 0x0001, 0x8000, 0x8000, 0x4000, 0x4000,
  0x0002, 0x0001, 0x0001, 0x8000, 0x4000, 0x4000,
  0x0002, 0x0002, 0x0001, 0x8000, 0x8000, 0x4000,
  0x0004, 0x0002, 0x0001, 0x8000, 0x0080,
  0x0004, 0x0002, 0x0001, 0x8000, 0x4000,
  0x0004, 0x0002, 0x0001, 0x8000, 0x4000,
  0x0004, 0x0002, 0x0001,
  0x4000,
  0x0000, 0x0000 ],

/* KO 14 – all zeros */
[ 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000 ],

/* KO 15 – all zeros */
[ 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000,
  0x0000,
  0x0000, 0x0000 ],

];

// Return KY register contribution for KO column
export function readKy(ko: number): number {
  const row = keyTab[ko & 0xF];
  return (row[keyCode1] | row[keyCode2] | row[keyCode2b]) & 0xFFFF;
}
